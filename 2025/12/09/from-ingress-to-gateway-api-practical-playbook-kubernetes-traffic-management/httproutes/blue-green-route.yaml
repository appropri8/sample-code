# HTTPRoute with header-based routing for blue-green deployments
# Routes to green (new) version when X-Canary header is present
# Otherwise routes to blue (current) version

apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: blue-green-route
  namespace: apps
  labels:
    app: my-app
    environment: production
spec:
  parentRefs:
    - name: production-gateway
      namespace: platform
  hostnames:
    - app.example.com
  rules:
    # Rule 1: Green (new) version for canary users
    # Matches requests with X-Canary: true header
    - matches:
        - headers:
            - name: X-Canary
              value: "true"
      backendRefs:
        - name: app-green
          port: 80
          weight: 100
    # Rule 2: Blue (current) version for everyone else
    # This rule matches all other requests
    - matches:
        - path:
            type: PathPrefix
            value: /
      backendRefs:
        - name: app-blue
          port: 80
          weight: 100

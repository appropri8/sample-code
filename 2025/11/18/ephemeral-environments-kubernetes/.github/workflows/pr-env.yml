name: PR Environment

on:
  pull_request:
    types: [opened, synchronize, closed]

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  deploy:
    if: github.event.action != 'closed'
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      
    - name: Log in to Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Build and push image
      uses: docker/build-push-action@v5
      with:
        context: .
        push: true
        tags: |
          ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:pr-${{ github.event.pull_request.number }}
          ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:pr-${{ github.event.pull_request.number }}-${{ github.sha }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
        
    - name: Set up kubectl
      uses: azure/setup-kubectl@v3
      
    - name: Configure kubectl
      run: |
        echo "${{ secrets.KUBECONFIG }}" | base64 -d > kubeconfig
        export KUBECONFIG=$(pwd)/kubeconfig
        
    - name: Deploy to Kubernetes
      run: |
        export KUBECONFIG=$(pwd)/kubeconfig
        export PR_NUMBER=${{ github.event.pull_request.number }}
        export NAMESPACE=pr-$PR_NUMBER
        export IMAGE_TAG=pr-$PR_NUMBER
        export REGISTRY=${{ env.REGISTRY }}
        export IMAGE_NAME=${{ env.IMAGE_NAME }}
        export GITHUB_REF_NAME=${{ github.head_ref || github.ref_name }}
        
        # Create namespace if it doesn't exist
        kubectl create namespace $NAMESPACE --dry-run=client -o yaml | kubectl apply -f -
        
        # Apply manifests with envsubst
        envsubst < k8s/deployment.yaml | kubectl apply -f -
        envsubst < k8s/service.yaml | kubectl apply -f -
        envsubst < k8s/ingress.yaml | kubectl apply -f -
        
    - name: Wait for deployment
      run: |
        export KUBECONFIG=$(pwd)/kubeconfig
        export NAMESPACE=pr-${{ github.event.pull_request.number }}
        kubectl wait --for=condition=available --timeout=300s deployment/myapp -n $NAMESPACE || true
        
    - name: Post PR comment
      uses: actions/github-script@v7
      with:
        script: |
          const prNumber = context.payload.pull_request.number;
          const previewUrl = `https://pr-${prNumber}.myapp.dev`;
          
          // Check if comment already exists
          const comments = await github.rest.issues.listComments({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: prNumber,
          });
          
          const existingComment = comments.data.find(
            c => c.user.type === 'Bot' && c.body.includes('Preview environment')
          );
          
          const body = `## ðŸš€ Preview Environment
          
          **Preview URL:** ${previewUrl}
          
          **Namespace:** \`pr-${prNumber}\`
          **Image:** \`${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:pr-${prNumber}\`
          
          This environment will be automatically deleted when the PR is closed.`;
          
          if (existingComment) {
            await github.rest.issues.updateComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: existingComment.id,
              body: body,
            });
          } else {
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: body,
            });
          }

  cleanup:
    if: github.event.action == 'closed'
    runs-on: ubuntu-latest
    
    steps:
    - name: Set up kubectl
      uses: azure/setup-kubectl@v3
      
    - name: Configure kubectl
      run: |
        echo "${{ secrets.KUBECONFIG }}" | base64 -d > kubeconfig
        export KUBECONFIG=$(pwd)/kubeconfig
        
    - name: Delete namespace
      run: |
        export KUBECONFIG=$(pwd)/kubeconfig
        export NAMESPACE=pr-${{ github.event.pull_request.number }}
        kubectl delete namespace $NAMESPACE --ignore-not-found=true
        
    - name: Post cleanup comment
      uses: actions/github-script@v7
      with:
        script: |
          await github.rest.issues.createComment({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: context.payload.pull_request.number,
            body: 'ðŸ§¹ Preview environment has been cleaned up.',
          });


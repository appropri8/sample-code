name: Build, Sign, and Deploy

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write  # Required for keyless signing
      packages: write  # Required to push images
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      
    - name: Log in to Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Build and push image
      uses: docker/build-push-action@v5
      with:
        context: .
        push: true
        tags: |
          ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
          ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
        cache-from: type=gha
        cache-to: type=gha,mode=max
        
    - name: Install Syft
      run: |
        curl -sSfL https://raw.githubusercontent.com/anchore/syft/main/install.sh | sh -s -- -b /usr/local/bin
        
    - name: Generate SBOM
      run: |
        syft ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }} \
          -o spdx-json > sbom.spdx.json
        echo "SBOM generated successfully"
        ls -lh sbom.spdx.json
        
    - name: Attach SBOM to image
      run: |
        # Install ORAS if not available
        if ! command -v oras &> /dev/null; then
          curl -LO https://github.com/oras-project/oras/releases/download/v1.1.0/oras_1.1.0_linux_amd64.tar.gz
          tar -xzf oras_1.1.0_linux_amd64.tar.gz
          sudo mv oras /usr/local/bin/
        fi
        
        oras push ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}-sbom \
          sbom.spdx.json:application/spdx+json \
          --username ${{ github.actor }} \
          --password ${{ secrets.GITHUB_TOKEN }}
        echo "SBOM attached to image as OCI artifact"
          
    - name: Install Cosign
      uses: sigstore/cosign-installer@v3
      
    - name: Sign image
      run: |
        cosign sign ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
      env:
        COSIGN_EXPERIMENTAL: 1  # Enable keyless signing
        
    - name: Verify signature
      run: |
        cosign verify ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }} \
          --certificate-identity-regexp ".*" \
          --certificate-oidc-issuer "https://token.actions.githubusercontent.com"
        echo "Image signature verified successfully"
          
    - name: Install Trivy
      uses: aquasecurity/trivy-action@master
      with:
        trivy-version: 'latest'
        
    - name: Check SBOM for critical CVEs
      run: |
        trivy sbom sbom.spdx.json --severity HIGH,CRITICAL --exit-code 0 || true
      continue-on-error: true  # Don't fail build, just warn
      
    - name: Upload SBOM artifact
      uses: actions/upload-artifact@v4
      with:
        name: sbom
        path: sbom.spdx.json
        retention-days: 30
        
    - name: Deploy to Kubernetes
      if: github.ref == 'refs/heads/main'
      run: |
        echo "Deploying ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}"
        # Add your deploy logic here
        # kubectl set image deployment/myapp myapp=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}

